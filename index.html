<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mfumo wa Kupiga Kura</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary-color: #007BFF;
            --secondary-color: #2C3E50;
            --background-color: #F4F7FA;
            --border-color: #DDE4E9;
            --hover-color: #E9F1FF;
            --text-color: #2C3E50;
            --text-secondary: #7F8C8D;
            --danger-color: #E74C3C;
            --success-color: #27AE60;
            --highlight-max: #FFD700;
            --highlight-min: #D3D3D3;
            --whatsapp-color: #25D366;
            --x-color: #000000;
            --facebook-color: #3B5998;
            --instagram-color: #E1306C;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 25px;
            box-sizing: border-box;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .poll-header {
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .poll-title {
            font-size: 22px;
            font-weight: 600;
            margin: 0;
            flex-grow: 1;
        }

        .time-remaining {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .poll-info {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }

        .poll-options {
            margin-bottom: 20px;
        }

        .poll-option {
            border: 1px solid var(--border-color);
            border-radius: 30px;
            padding: 15px 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
        }

        .poll-option:hover {
            background-color: var(--hover-color);
            transform: translateX(5px);
        }

        .poll-option.selected {
            border-color: var(--primary-color);
            background-color: var(--hover-color);
        }

        .poll-option.disabled {
            cursor: default;
        }

        .poll-option.most-voted {
            border-color: var(--highlight-max);
            background-color: rgba(255, 215, 0, 0.1);
        }

        .poll-option.least-voted {
            border-color: var(--highlight-min);
            background-color: rgba(211, 211, 211, 0.1);
        }

        .poll-option-text {
            font-size: 16px;
            flex-grow: 1;
        }

        .poll-result {
            display: none;
            height: 10px;
            background-color: var(--primary-color);
            border-radius: 5px;
            margin-top: 10px;
            width: 0;
            transition: width 1s ease-in-out;
        }

        .poll-percentage {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: right;
            display: none;
            margin-top: 5px;
        }

        .vote-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .vote-btn:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }

        .vote-btn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        .share-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .share-btn:hover {
            background-color: #1A3C34;
            transform: scale(1.05);
        }

        .share-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffffff, #f0f4ff);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            text-align: center;
            animation: slideUp 0.5s ease-in-out;
            width: 90%;
            max-width: 300px;
        }

        .share-popup p {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .share-popup button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-popup button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .share-popup .whatsapp-btn {
            background-color: var(--whatsapp-color);
        }

        .share-popup .x-btn {
            background-color: var(--x-color);
        }

        .share-popup .facebook-btn {
            background-color: var(--facebook-color);
        }

        .share-popup .instagram-btn {
            background-color: var(--instagram-color);
        }

        .share-popup .close-btn {
            background-color: var(--danger-color);
            margin-top: 15px;
        }

        .results-info {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 20px;
            display: none;
        }

        .total-votes {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .error-message {
            color: var(--danger-color);
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        .style-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
        }

        .toggle-btn {
            background-color: var(--border-color);
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-btn:first-child {
            border-radius: 20px 0 0 20px;
        }

        .toggle-btn:last-child {
            border-radius: 0 20px 20px 0;
        }

        .toggle-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .whatsapp-theme {
            --primary-color: #00C4B4;
            --secondary-color: #1A3C34;
            --background-color: #F0F2F5;
            --border-color: #DDE4E9;
            --hover-color: #E6ECEF;
        }

        .create-poll-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            display: block;
        }

        .create-poll-btn:hover {
            background-color: #1A3C34;
            transform: scale(1.05);
        }

        .create-poll-form, .edit-poll-form {
            display: none;
            margin-top: 20px;
            animation: slideIn 0.5s ease-in-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .option-input-container {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }

        .option-input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .option-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .remove-option-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-option-btn:hover {
            background-color: #C0392B;
            transform: scale(1.1);
        }

        .add-option-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-option-btn:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }

        .submit-poll-btn, .update-poll-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .submit-poll-btn:hover, .update-poll-btn:hover {
            background-color: #219653;
            transform: scale(1.05);
        }

        .admin-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in-out;
            display: none;
        }

        .admin-poll-card {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .admin-poll-card div {
            margin-bottom: 10px;
        }

        .admin-poll-card strong {
            color: var(--primary-color);
        }

        .options-list {
            margin-left: 20px;
        }

        .options-list div {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .delete-btn, .edit-btn, .back-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .edit-btn {
            background-color: var(--primary-color);
        }

        .delete-btn:hover, .edit-btn:hover, .back-btn:hover {
            transform: scale(1.05);
        }

        .delete-btn:hover {
            background-color: #C0392B;
        }

        .edit-btn:hover {
            background-color: #0056b3;
        }

        .icon {
            margin-right: 10px;
            font-size: 18px;
        }

        .password-modal, .error-modal, .name-form-modal, .change-password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-in-out;
        }

        .password-modal-content, .error-modal-content, .name-form-content, .change-password-content {
            background: linear-gradient(135deg, #ffffff, #f0f4ff);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
            text-align: center;
            animation: slideUp 0.5s ease-in-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .password-modal-content h2, .error-modal-content h2, .name-form-content h2, .change-password-content h2 {
            margin: 0 0 25px;
            font-size: 26px;
            color: var(--primary-color);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .password-modal-content input, .name-form-content input, .change-password-content input {
            width: 100%;
            padding: 15px;
            margin-bottom: 25px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background-color: #fafafa;
        }

        .password-modal-content input:focus, .name-form-content input:focus, .change-password-content input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
            outline: none;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .password-modal-content button, .error-modal-content button, .name-form-content button, .change-password-content button {
            background: linear-gradient(90deg, var(--primary-color), #0056b3);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .error-modal-content p {
            color: var(--danger-color);
            font-size: 16px;
            margin: 20px 0;
        }

        .password-modal-content button:hover, .error-modal-content button:hover, .name-form-content button:hover, .change-password-content button:hover {
            background: linear-gradient(90deg, #0056b3, var(--primary-color));
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
        }

        .time-expired {
            color: var(--danger-color);
            font-weight: bold;
        }

        body.dark-mode {
            --background-color: #1A1A1A;
            --text-color: #FFFFFF;
            --border-color: #444;
            --hover-color: #333;
        }

        body.dark-mode .container, body.dark-mode .admin-section {
            background-color: #2D2D2D;
        }

        body.dark-mode .password-modal-content, body.dark-mode .error-modal-content, body.dark-mode .name-form-content, body.dark-mode .change-password-content {
            background: linear-gradient(135deg, #2D2D2D, #444);
        }

        body.dark-mode .share-popup {
            background: linear-gradient(135deg, #2D2D2D, #444);
        }

        body.dark-mode .share-popup p {
            color: #FFFFFF;
        }

        .mode-toggle {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .mode-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="style-toggle">
            <button class="toggle-btn active" data-theme="twitter">OLD STYLE</button>
            <button class="toggle-btn" data-theme="whatsapp">MORDEN STYLE</button>
        </div>

        <button class="create-poll-btn"><span class="icon">‚úçÔ∏è</span>malosha use only</button>
        
        <div class="create-poll-form">
            <div class="form-group">
                <label class="form-label" for="poll-title"><span class="icon">‚ùì</span>Swali la Kura:</label>
                <input type="text" id="poll-title" class="form-input" placeholder="Andika swali lako hapa">
            </div>
            <div class="form-group">
                <label class="form-label"><span class="icon">‚úÖ</span>Chaguo:</label>
                <div id="options-container">
                    <div class="option-input-container">
                        <input type="text" class="option-input" placeholder="Chaguo 1">
                        <button class="remove-option-btn">‚úï</button>
                    </div>
                    <div class="option-input-container">
                        <input type="text" class="option-input" placeholder="Chaguo 2">
                        <button class="remove-option-btn">‚úï</button>
 </div>
                </div>
                <button class="add-option-btn"><span class="icon">‚ûï</span>Ongeza Chaguo</button>
            </div>
            <div class="form-group">
                <label class="form-label" for="poll-duration"><span class="icon">‚è≥</span>Muda wa Kura:</label>
                <input type="number" id="poll-duration" class="form-input" min="1" placeholder="Weka muda wa mwisho wa upigaji kura">
                <select id="duration-unit" class="form-select">          
                    <option value="seconds">Sekunde</option>
                    <option value="minutes">Dakika</option>
                    <option value="hours">Saa</option>
                    <option value="weeks">Wiki</option>
                    <option value="months">Mwezi</option>
                    <option value="years">Mwaka</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="results-visibility"><span class="icon">üëÅÔ∏è</span>Matokeo Yaonekane:</label>
                <select id="results-visibility" class="form-select">
                    <option value="always">Muda Wote</option>
                    <option value="after-poll-ends">Hadi Kura Imalize</option>
                    <option value="admin-only">Admin Pekee</option>
                    <option value="after-voting">Baada ya Kupiga Kura</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="require-name"><span class="icon">üë§</span>Jina la Mpigaji Kura:</label>
                <select id="require-name" class="form-select">
                    <option value="no">Haitajiki</option>
                    <option value="yes">Inahitajika</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="vote-limit"><span class="icon">üî¢</span>Mara za Kupiga Kura:</label>
                <input type="number" id="vote-limit" class="form-input" min="1" value="1">
            </div>
            <div class="form-group">
                <label class="form-label" for="vote-restriction"><span class="icon">üîê</span>Zuia Kurudia Kura:</label>
                <select id="vote-restriction" class="form-select">
                    <option value="multiple">Mara Nyingi</option>
                    <option value="session">Kwa Session</option>
                    <option value="ip">Kwa IP</option>
                    <option value="email">Kwa Email (Inakuja Hivi Karibuni)</option>
                    <option value="code">Kwa Code ya Kipekee</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="block-vpn"><span class="icon">üåê</span>Zuia VPN:</label>
                <select id="block-vpn" class="form-select">
                    <option value="no">Hapana</option>
                    <option value="yes">Ndio</option>
                </select>
            </div>
            <button class="submit-poll-btn"><span class="icon">üöÄ</span>Tengeneza Kura</button>
        </div>

        <div class="edit-poll-form">
            <div class="form-group">
                <label class="form-label" for="edit-poll-title"><span class="icon">‚ùì</span>Swali la Kura:</label>
                <input type="text" id="edit-poll-title" class="form-input" placeholder="Andika swali lako hapa">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-poll-duration"><span class="icon">‚è≥</span>Muda wa Kura:</label>
                <input type="number" id="edit-poll-duration" class="form-input" min="1" placeholder="Weka muda wa mwisho">
                <select id="edit-duration-unit" class="form-select">
                    <option value="seconds">Sekunde</option>
                    <option value="minutes">Dakika</option>
                    <option value="hours">Saa</option>
                    <option value="weeks">Wiki</option>
                    <option value="months">Mwezi</option>
                    <option value="years">Mwaka</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label"><span class="icon">‚úÖ</span>Chaguo:</label>
                <div id="edit-options-container"></div>
                <button class="add-option-btn"><span class="icon">‚ûï</span>Ongeza Chaguo</button>
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-results-visibility"><span class="icon">üëÅÔ∏è</span>Matokeo Yaonekane:</label>
                <select id="edit-results-visibility" class="form-select">
                    <option value="always">Muda Wote</option>
                    <option value="after-poll-ends">Hadi Kura Imalize</option>
                    <option value="admin-only">Admin Pekee</option>
                    <option value="after-voting">Baada ya Kupiga Kura</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-require-name"><span class="icon">üë§</span>Jina la Mpigaji Kura:</label>
                <select id="edit-require-name" class="form-select">
                    <option value="no">Haitajiki</option>
                    <option value="yes">Inahitajika</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-vote-limit"><span class="icon">üî¢</span>Mara za Kupiga Kura:</label>
                <input type="number" id="edit-vote-limit" class="form-input" min="1" value="1">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-vote-restriction"><span class="icon">üîê</span>Zuia Kurudia Kura:</label>
                <select id="edit-vote-restriction" class="form-select">
                    <option value="multiple">Mara Nyingi</option>
                    <option value="session">Kwa Session</option>
                    <option value="ip">Kwa IP</option>
                    <option value="email">Kwa Email (Inakuja Hivi Karibuni)</option>
                    <option value="code">Kwa Code ya Kipekee</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-block-vpn"><span class="icon">üåê</span>Zuia VPN:</label>
                <select id="edit-block-vpn" class="form-select">
                    <option value="no">Hapana</option>
                    <option value="yes">Ndio</option>
                </select>
            </div>
            <button class="update-poll-btn"><span class="icon">üîÑ</span>Rekebisha Kura</button>
        </div>

        <div id="active-poll">
            <div class="poll-header">
                <div>
                    <div class="poll-title"></div>
                    <div class="time-remaining"></div>
                </div>
                <span class="icon">üïí</span>
            </div>
            <div class="poll-info">
                <span class="poll-author"></span>
                <span class="poll-date"></span>
            </div>
            <div class="poll-options" id="poll-options"></div>
            <button id="vote-btn" class="vote-btn" disabled><span class="icon">üó≥Ô∏è</span>Piga Kura</button>
            <button id="share-poll-btn" class="share-btn"><span class="icon">üì§</span>Shiriki Kura</button>
            <div id="error-message" class="error-message"></div>
            <div class="results-info">Matokeo yataonekana baada ya kupiga kura</div>
            <div class="total-votes">Jumla ya kura: <span id="votes-count">0</span></div>
        </div>

        <div class="admin-section" id="admin-section">
            <h2><span class="icon">üë§</span>Admin Panel</h2>
            <button class="back-btn" id="back-btn"><span class="icon">‚¨ÖÔ∏è</span>Rudi Nyuma</button>
            <button class="edit-btn" id="change-password-btn"><span class="icon">üîë</span>Badilisha Nenosiri</button>
            <div id="admin-polls-list"></div>
            <h3><span class="icon">üìú</span>Historia ya Kura</h3>
            <div id="admin-history-list"></div>
        </div>

        <div class="mode-toggle">
            <button class="mode-btn" id="light-mode">Light Mode</button>
            <button class="mode-btn" id="dark-mode">Dark Mode</button>
        </div>
    </div>

    <div class="password-modal" id="password-modal">
        <div class="password-modal-content">
            <h2><span class="icon">üîí</span>TRY ANY PASSWORD </h2>
            <input type="password" id="password-input" placeholder="Nenosiri">
            <div class="modal-buttons">
                <button class="back-btn" id="password-back-btn"><span class="icon">‚¨ÖÔ∏è</span>Rudi Nyuma</button>
                <button id="password-submit"><span class="icon">‚úÖ</span>Thibitisha</button>
            </div>
        </div>
    </div>

    <div class="error-modal" id="error-modal">
        <div class="error-modal-content">
            <h2><span class="icon">‚ö†Ô∏è</span>Hatakiwi</h2>
            <p>Nenosiri sio sahihi! Tafadhali wasiliana na David Malosha Amos kwa namba <strong>0785197452</strong> au <strong>0623715858</strong> kupitia WhatsApp ili upate nenosiri sahihi.</p>
            <button id="error-close-btn"><span class="icon">‚úñÔ∏è</span>Funga</button>
        </div>
    </div>

    <div class="name-form-modal" id="name-form-modal">
        <div class="name-form-content">
            <h2><span class="icon">üë§</span>Jaza Jina Lako</h2>
            <input type="text" id="voter-name" class="form-input" placeholder="Jina lako">
            <div class="modal-buttons">
                <button id="name-submit-btn"><span class="icon">‚úÖ</span>Thibitisha</button>
                <button id="name-cancel-btn"><span class="icon">‚úñÔ∏è</span>Ghairi</button>
            </div>
        </div>
    </div>

    <div class="change-password-modal" id="change-password-modal">
        <div class="change-password-content">
            <h2><span class="icon">üîë</span>Badilisha Nenosiri</h2>
            <input type="password" id="current-password" class="form-input" placeholder="Nenosiri la Sasa">
            <input type="password" id="new-password" class="form-input" placeholder="Nenosiri Jipya">
            <input type="password" id="confirm-password" class="form-input" placeholder="Thibitisha Nenosiri Jipya">
            <div class="modal-buttons">
                <button id="change-password-submit"><span class="icon">‚úÖ</span>Badilisha</button>
                <button id="change-password-cancel"><span class="icon">‚úñÔ∏è</span>Ghairi</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBxibHHgfBunsCVowPCKWDIV2K3kG9OviE",
            authDomain: "x-poll-6dc62.firebaseapp.com",
            databaseURL: "https://x-poll-6dc62-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "x-poll-6dc62",
            storageBucket: "x-poll-6dc62.firebasestorage.app",
            messagingSenderId: "463476174133",
            appId: "1:463476174133:web:9c68ee0f855b6e0c28b07c",
            measurementId: "G-T5N05Z0ETF"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const defaultPoll = {
            id: 'default-poll',
            title: 'Muda wa kura unaweza kuisha lini?',
            author: 'maloshadavid@92gmail.com',
            date: new Date().toLocaleDateString('sw'),
            options: [
                { id: 1, text: 'Saa 1', votes: 0 },
                { id: 2, text: 'Saa 2', votes: 0 }
            ],
            totalVotes: 0,
            duration: 5,
            durationUnit: 'minutes',
            endTime: null,
            isExpired: false,
            resultsVisibility: 'after-voting',
            voters: {},
            settings: {
                requireName: 'no',
                voteLimit: 1,
                voteRestriction: 'ip',
                blockVpn: 'no'
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const pollOptionsEl = document.getElementById('poll-options');
            const voteBtn = document.getElementById('vote-btn');
            const sharePollBtn = document.getElementById('share-poll-btn');
            const errorMessage = document.getElementById('error-message');
            const resultsInfo = document.querySelector('.results-info');
            const totalVotesEl = document.querySelector('.total-votes');
            const votesCountEl = document.getElementById('votes-count');
            const timeRemainingEl = document.querySelector('.time-remaining');
            const themeToggleBtns = document.querySelectorAll('.toggle-btn');
            const createPollBtn = document.querySelector('.create-poll-btn');
            const createPollForm = document.querySelector('.create-poll-form');
            const editPollForm = document.querySelector('.edit-poll-form');
            const activePollEl = document.getElementById('active-poll');
            const adminSection = document.getElementById('admin-section');
            const adminPollsList = document.getElementById('admin-polls-list');
            const adminHistoryList = document.getElementById('admin-history-list');
            const passwordModal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            const passwordSubmit = document.getElementById('password-submit');
            const passwordBackBtn = document.getElementById('password-back-btn');
            const backBtn = document.getElementById('back-btn');
            const lightModeBtn = document.getElementById('light-mode');
            const darkModeBtn = document.getElementById('dark-mode');
            const errorModal = document.getElementById('error-modal');
            const errorCloseBtn = document.getElementById('error-close-btn');
            const nameFormModal = document.getElementById('name-form-modal');
            const voterNameInput = document.getElementById('voter-name');
            const nameSubmitBtn = document.getElementById('name-submit-btn');
            const nameCancelBtn = document.getElementById('name-cancel-btn');
            const changePasswordModal = document.getElementById('change-password-modal');
            const changePasswordBtn = document.getElementById('change-password-btn');
            const currentPasswordInput = document.getElementById('current-password');
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const changePasswordSubmit = document.getElementById('change-password-submit');
            const changePasswordCancel = document.getElementById('change-password-cancel');

            let selectedOption = null;
            let currentPoll = null;
            let allPolls = [];
            let pollHistory = [];
            let hasVoted = false;
            let isAdmin = false;
            let userIp = null;
            let voterName = null;
            let sessionVoted = false;
            let adminPassword = "1340"; // Default password

            function init() {
                loadAdminPassword();
                getUserIp(ip => {
                    userIp = ip;
                    loadPollsFromFirebase();
                });
                loadHistoryFromFirebase();
                setupEventListeners();
                checkPollExpiration();
                updateTimeRemaining();
            }

            function sanitizeKey(key) {
                return key.replace(/[.#$/[\]]/g, '_');
            }

            function loadAdminPassword() {
                db.ref('adminPassword').once('value', (snapshot) => {
                    const savedPassword = snapshot.val();
                    if (savedPassword) adminPassword = savedPassword;
                });
            }

            function saveAdminPassword(newPassword) {
                adminPassword = newPassword;
                db.ref('adminPassword').set(newPassword);
            }

            function loadPollsFromFirebase() {
                db.ref('polls').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        allPolls = Object.values(data).map(poll => ({
                            ...poll,
                            voters: poll.voters || {},
                            settings: poll.settings || { requireName: 'no', voteLimit: 1, voteRestriction: 'ip', blockVpn: 'no' }
                        }));
                        currentPoll = allPolls[0];
                        renderPoll();
                        if (shouldShowResults()) showResults();
                        if (isAdmin) updateAdminPanel();
                    } else {
                        allPolls = [defaultPoll];
                        allPolls[0].endTime = new Date().getTime() + defaultPoll.duration * 60000;
                        currentPoll = allPolls[0];
                        savePollsToFirebase();
                        renderPoll();
                        if (shouldShowResults()) showResults();
                    }
                    checkIfUserVoted();
                });
            }

            function loadHistoryFromFirebase() {
                db.ref('history').once('value', (snapshot) => {
                    const data = snapshot.val();
                    pollHistory = data ? Object.values(data) : [];
                    if (isAdmin) updateAdminPanel();
                });
            }

            function savePollsToFirebase() {
                db.ref('polls').set(allPolls);
            }

            function saveHistoryToFirebase() {
                db.ref('history').set(pollHistory);
            }

            function getUserIp(callback) {
                fetch('https://api.ipify.org?format=json')
                    .then(response => response.json())
                    .then(data => callback(data.ip))
                    .catch(() => callback('unknown_' + Date.now()));
            }

            function detectVPN(callback) {
                fetch('https://ipapi.co/json/')
                    .then(response => response.json())
                    .then(data => callback(data.security?.proxy || data.security?.vpn || false))
                    .catch(() => callback(false));
            }

            function renderPoll() {
                if (!currentPoll) return;
                document.querySelector('.poll-title').textContent = currentPoll.title;
                document.querySelector('.poll-author').textContent = currentPoll.author;
                document.querySelector('.poll-date').textContent = currentPoll.date;

                pollOptionsEl.innerHTML = '';
                currentPoll.options.forEach(option => {
                    const optionEl = document.createElement('div');
                    optionEl.className = 'poll-option';
                    optionEl.dataset.option = option.id;
                    optionEl.innerHTML = `
                        <div class="poll-option-text">${option.text}</div>
                        <div class="poll-result"></div>
                        <div class="poll-percentage">0%</div>
                    `;
          pollOptionsEl.appendChild(optionEl);
                });

                selectedOption = null;
                voteBtn.disabled = true;
                errorMessage.style.display = 'none';
                totalVotesEl.style.display = shouldShowResults() ? 'block' : 'none';
                votesCountEl.textContent = currentPoll.totalVotes;
                resultsInfo.style.display = shouldShowResults() ? 'none' : 'block';

                document.querySelectorAll('.poll-option').forEach(option => {
                    option.addEventListener('click', selectOption);
                });

                activePollEl.style.display = 'block';
            }

            function checkIfUserVoted() {
                if (!currentPoll || !userIp) return;
                const sanitizedIp = sanitizeKey(userIp);

                if (currentPoll.settings.voteRestriction === 'session') {
                    hasVoted = sessionVoted;
                } else if (currentPoll.settings.voteRestriction === 'ip') {
                    const voterData = currentPoll.voters[sanitizedIp];
                    hasVoted = voterData ? voterData.votes >= currentPoll.settings.voteLimit : false;
                } else if (currentPoll.settings.voteRestriction === 'multiple') {
                    hasVoted = false; // Multiple votes allowed
                } else if (currentPoll.settings.voteRestriction === 'code') {
                    hasVoted = currentPoll.voters[sanitizedIp] ? currentPoll.voters[sanitizedIp].votes >= currentPoll.settings.voteLimit : false;
                }

                if (hasVoted || currentPoll.isExpired) {
                    voteBtn.disabled = true;
                    document.querySelectorAll('.poll-option').forEach(option => {
                        option.classList.add('disabled');
                    });
                } else {
                    voteBtn.disabled = false;
                    document.querySelectorAll('.poll-option').forEach(option => {
                        option.classList.remove('disabled');
                    });
                }
            }

            function selectOption() {
                if (hasVoted || currentPoll.isExpired) return;

                document.querySelectorAll('.poll-option').forEach(option => {
                    option.classList.remove('selected');
                });

                this.classList.add('selected');
                selectedOption = parseInt(this.dataset.option);
                voteBtn.disabled = false;
            }

            function shouldShowResults() {
                if (!currentPoll) return false;
                switch (currentPoll.resultsVisibility) {
                    case 'always':
                        return true;
                    case 'after-poll-ends':
                        return currentPoll.isExpired;
                    case 'admin-only':
                        return isAdmin;
                    case 'after-voting':
                        return hasVoted || currentPoll.isExpired;
                    default:
                        return false;
                }
            }

            function submitVote() {
                if (!selectedOption || !currentPoll) {
                    errorMessage.textContent = 'Tafadhali chagua chaguo moja';
                    errorMessage.style.display = 'block';
                    return;
                }

                detectVPN(isVpn => {
                    if (currentPoll.settings.blockVpn === 'yes' && isVpn) {
                        errorMessage.textContent = 'Hauwezi kupiga kura ukitumia VPN!';
                        errorMessage.style.display = 'block';
                        return;
                    }

                    if (currentPoll.settings.requireName === 'yes' && !voterName) {
                        nameFormModal.style.display = 'flex';
                        voterNameInput.focus();
                        return;
                    }

                    checkIfUserVoted();
                    if (hasVoted) {
                        errorMessage.textContent = `Umeshapiga kura zaidi ya mara ${currentPoll.settings.voteLimit} zinazoruhusiwa!`;
                        errorMessage.style.display = 'block';
                        return;
                    }

                    const option = currentPoll.options.find(o => o.id === selectedOption);
                    if (option) {
                        option.votes++;
                        currentPoll.totalVotes++;
                        const sanitizedIp = sanitizeKey(userIp);
                        if (!currentPoll.voters[sanitizedIp]) {
                            currentPoll.voters[sanitizedIp] = { votes: 0, name: voterName || 'Anonymous' };
                        }
                        currentPoll.voters[sanitizedIp].votes++;
                        currentPoll.voters[sanitizedIp].optionId = selectedOption;
                        currentPoll.voters[sanitizedIp].timestamp = new Date().toISOString();

                        if (currentPoll.settings.voteRestriction === 'session') {
                            sessionVoted = true;
                        }

                        const pollIndex = allPolls.findIndex(p => p && p.id === currentPoll.id);
                        if (pollIndex !== -1) {
                            allPolls[pollIndex] = currentPoll;
                            savePollsToFirebase();
                        }

                        hasVoted = currentPoll.settings.voteLimit <= currentPoll.voters[sanitizedIp].votes;
                        checkIfUserVoted();
                        if (shouldShowResults()) showResults();
                        alert(`Kura yako imepokelewa kwa Malosha${voterName ? `, ${voterName}` : ''}`);
                        voterName = null; // Reset voter name after submission
                    }
                });
            }

            function sharePoll() {
                if (!currentPoll) return;
                const pollData = {
                    id: currentPoll.id,
                    title: currentPoll.title,
                    options: currentPoll.options.map(o => o.text),
                    endTime: currentPoll.endTime,
                    totalVotes: currentPoll.totalVotes
                };
                const encodedPoll = encodeURIComponent(JSON.stringify(pollData));
                const shareUrl = `${window.location.origin}${window.location.pathname}?poll=${encodedPoll}`;
                const shareText = `Piga kura: "${currentPoll.title}" - ${shareUrl}`;

                const sharePopup = document.createElement('div');
                sharePopup.className = 'share-popup';
                sharePopup.innerHTML = `
                    <p>Shiriki Kura Hii:</p>
                    <button class="whatsapp-btn"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                    <button class="x-btn"><i class="fab fa-x-twitter"></i> X</button>
                    <button class="facebook-btn"><i class="fab fa-facebook-f"></i> Facebook</button>
                    <button class="instagram-btn"><i class="fab fa-instagram"></i> Instagram</button>
                    <button class="close-btn"><i class="fas fa-times"></i> Funga</button>
                `;
                document.body.appendChild(sharePopup);

                sharePopup.querySelector('.whatsapp-btn').addEventListener('click', () => {
                    window.open(`https://wa.me/?text=${encodeURIComponent(shareText)}`, '_blank');
                    document.body.removeChild(sharePopup);
                });

                sharePopup.querySelector('.x-btn').addEventListener('click', () => {
                    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`, '_blank');
                    document.body.removeChild(sharePopup);
                });

                sharePopup.querySelector('.facebook-btn').addEventListener('click', () => {
                    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`, '_blank');
                    document.body.removeChild(sharePopup);
                });

                sharePopup.querySelector('.instagram-btn').addEventListener('click', () => {
                    window.open(`https://www.instagram.com/?url=${encodeURIComponent(shareUrl)}`, '_blank');
                    document.body.removeChild(sharePopup);
                });

                sharePopup.querySelector('.close-btn').addEventListener('click', () => {
                    document.body.removeChild(sharePopup);
                });
            }

            function showResults() {
                if (!currentPoll) return;
                const totalVotes = currentPoll.totalVotes || 0;
                let maxVotes = -1;
                let minVotes = Infinity;
                currentPoll.options.forEach(option => {
                    maxVotes = Math.max(maxVotes, option.votes);
                    minVotes = Math.min(minVotes, option.votes);
                });

                document.querySelectorAll('.poll-option').forEach(optionEl => {
                    const optionId = parseInt(optionEl.dataset.option);
                    const option = currentPoll.options.find(o => o.id === optionId);
                    if (option) {
                        const percentage = totalVotes > 0 ? (option.votes / totalVotes) * 100 : 0;
                        const roundedPercentage = Math.round(percentage);

                        const resultEl = optionEl.querySelector('.poll-result');
                        const percentageEl = optionEl.querySelector('.poll-percentage');

                        resultEl.style.display = 'block';
                        setTimeout(() => {
                            resultEl.style.width = `${percentage}%`;
                        }, 50);
                        percentageEl.style.display = 'block';
                        percentageEl.textContent = `${roundedPercentage}% (${option.votes} kura)`;

                        optionEl.classList.remove('most-voted', 'least-voted');
                        if (totalVotes > 0) {
                            if (option.votes === maxVotes && maxVotes > 0) {
                                optionEl.classList.add('most-voted');
                            }
                            if (option.votes === minVotes) {
                                optionEl.classList.add('least-voted');
                            }
                        }
                    }
                });

                totalVotesEl.style.display = 'block';
                votesCountEl.textContent = totalVotes;
                resultsInfo.style.display = 'none';
                errorMessage.style.display = 'none';
            }

            function toggleTheme(theme) {
                const container = document.querySelector('.container');
                if (theme === 'whatsapp') {
                    container.classList.add('whatsapp-theme');
                } else {
                    container.classList.remove('whatsapp-theme');
                }
                createPollBtn.style.display = 'block';
            }

            function formatTimeRemaining(ms) {
                const seconds = Math.floor(ms / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);
                const weeks = Math.floor(days / 7);
                const months = Math.floor(days / 30);
                const years = Math.floor(days / 365);
                if (years > 0) return `${years} mwaka${years > 1 ? 's' : ''}`;
                if (months > 0) return `${months} mwezi${months > 1 ? 's' : ''}`;
                if (weeks > 0) return `${weeks} wiki${weeks > 1 ? 's' : ''}`;
                if (days > 0) return `${days} siku${days > 1 ? 's' : ''}`;
                if (hours > 0) return `${hours} saa${hours > 1 ? 's' : ''}`;
                if (minutes > 0) return `${minutes} dakika${minutes > 1 ? 's' : ''}`;
                return `${seconds} sekunde${seconds > 1 ? 's' : ''}`;
            }

            function updateTimeRemaining() {
                setInterval(() => {
                    if (!currentPoll || !currentPoll.endTime) return;
                    const now = new Date().getTime();
                    const timeLeft = currentPoll.endTime - now;
                    if (timeLeft > 0) {
                        timeRemainingEl.textContent = `Muda uliobaki: ${formatTimeRemaining(timeLeft)}`;
                        timeRemainingEl.classList.remove('time-expired');
                    } else {
                        timeRemainingEl.textContent = 'Muda wa kupiga kura umekwisha';
                        timeRemainingEl.classList.add('time-expired');
                        currentPoll.isExpired = true;
                        voteBtn.disabled = true;
                        document.querySelectorAll('.poll-option').forEach(option => {
                            option.classList.add('disabled');
                        });
                        if (shouldShowResults()) showResults();
                    }
                }, 1000);
            }

            function checkPollExpiration() {
                setInterval(() => {
                    const now = new Date().getTime();
                    allPolls.forEach(poll => {
                        if (poll.endTime && now > poll.endTime && !poll.isExpired) {
                            poll.isExpired = true;
                            pollHistory.push(poll);
                            allPolls = allPolls.filter(p => p.id !== poll.id);
                            savePollsToFirebase();
                            saveHistoryToFirebase();
                            if (currentPoll && currentPoll.id === poll.id) {
                                if (shouldShowResults()) showResults();
                                voteBtn.disabled = true;
                            }
                        }
                    });
                    if (isAdmin) updateAdminPanel();
                }, 1000);
            }

            function updateAdminPanel() {
                if (!isAdmin) return;

                adminPollsList.innerHTML = '';
                allPolls.forEach(poll => {
                    const timeLeft = poll.endTime ? Math.max(0, poll.endTime - new Date().getTime()) : 0;
                    const card = document.createElement('div');
                    card.className = 'admin-poll-card';
                    let optionsHtml = '<div><strong>Chaguo:</strong></div><div class="options-list">';
                    poll.options.forEach(option => {
                        optionsHtml += `<div>${option.text}: ${option.votes} kura</div>`;
                    });
                    optionsHtml += '</div>';
                    let votersHtml = '<div><strong>Waliopiga Kura:</strong></div><div class="options-list">';
                    for (const ip in poll.voters) {
                        votersHtml += `<div>${poll.voters[ip].name} - Mara ${poll.voters[ip].votes}</div>`;
                    }
                    votersHtml += '</div>';
                    card.innerHTML = `
                        <div><strong>Swali:</strong> ${poll.title}</div>
                        <div><strong>Kura:</strong> ${poll.totalVotes}</div>
                        ${optionsHtml}
                        <div><strong>Muda:</strong> ${poll.isExpired ? 'Imemalizika' : formatTimeRemaining(timeLeft)}</div>
                        <div><strong>Matokeo:</strong> ${
                            poll.resultsVisibility === 'always' ? 'Muda Wote' :
                            poll.resultsVisibility === 'after-poll-ends' ? 'Hadi Kura Imalize' :
                            poll.resultsVisibility === 'admin-only' ? 'Admin Pekee' :
                            'Baada ya Kupiga Kura'
                        }</div>
                        <div><strong>Jina:</strong> ${poll.settings.requireName === 'yes' ? 'Inahitajika' : 'Haitajiki'}</div>
                        <div><strong>Mara za Kura:</strong> ${poll.settings.voteLimit}</div>
                        <div><strong>Zuia Kurudia:</strong> ${poll.settings.voteRestriction}</div>
                        <div><strong>Zuia VPN:</strong> ${poll.settings.blockVpn === 'yes' ? 'Ndio' : 'Hapana'}</div>
                        ${votersHtml}
                        <button class="edit-btn" data-id="${poll.id}"><span class="icon">‚úèÔ∏è</span>Hariri</button>
                        <button class="delete-btn" data-id="${poll.id}"><span class="icon">üóëÔ∏è</span>Futa</button>
                    `;
                    adminPollsList.appendChild(card);
                });

                adminHistoryList.innerHTML = '';
                pollHistory.forEach(poll => {
                    const card = document.createElement('div');
                    card.className = 'admin-poll-card';
                    let optionsHtml = '<div><strong>Chaguo:</strong></div><div class="options-list">';
                    poll.options.forEach(option => {
                        optionsHtml += `<div>${option.text}: ${option.votes} kura</div>`;
                    });
                    optionsHtml += '</div>';
                    let votersHtml = '<div><strong>Waliopiga Kura:</strong></div><div class="options-list">';
                    for (const ip in poll.voters) {
                        votersHtml += `<div>${poll.voters[ip].name} - Mara ${poll.voters[ip].votes}</div>`;
                    }
                    votersHtml += '</div>';
                    card.innerHTML = `
                        <div><strong>Swali:</strong> ${poll.title}</div>
                        <div><strong>Jumla ya Kura:</strong> ${poll.totalVotes}</div>
                        ${optionsHtml}
                        <div><strong>Muda:</strong> Imemalizika</div>
                        ${votersHtml}
                        <button class="delete-btn" data-id="${poll.id}"><span class="icon">üóëÔ∏è</span>Futa</button>
                    `;
                    adminHistoryList.appendChild(card);
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const pollId = btn.dataset.id;
                        allPolls = allPolls.filter(p => p.id !== pollId);
                        pollHistory = pollHistory.filter(p => p.id !== pollId);
                        savePollsToFirebase();
                        saveHistoryToFirebase();
                        updateAdminPanel();
                        if (currentPoll && currentPoll.id === pollId) {
                            currentPoll = allPolls[0] || null;
                            renderPoll();
                        }
                    });
                });

                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const pollId = btn.dataset.id;
                        const poll = allPolls.find(p => p.id === pollId);
                        if (poll) {
                            editPollForm.style.display = 'block';
                            createPollForm.style.display = 'none';
                            document.getElementById('edit-poll-title').value = poll.title;
                            document.getElementById('edit-poll-duration').value = poll.duration;
                            document.getElementById('edit-duration-unit').value = poll.durationUnit;
                            document.getElementById('edit-results-visibility').value = poll.resultsVisibility;
                            document.getElementById('edit-require-name').value = poll.settings.requireName;
                            document.getElementById('edit-vote-limit').value = poll.settings.voteLimit;
                            document.getElementById('edit-vote-restriction').value = poll.settings.voteRestriction;
                            document.getElementById('edit-block-vpn').value = poll.settings.blockVpn;
                            const editOptionsContainer = document.getElementById('edit-options-container');
                            editOptionsContainer.innerHTML = '';
                            poll.options.forEach(option => {
                                const optionDiv = document.createElement('div');
                                optionDiv.className = 'option-input-container';
                                optionDiv.innerHTML = `
                                    <input type="text" class="option-input" value="${option.text}">
                                    <button class="remove-option-btn">‚úï</button>
                                `;
                                editOptionsContainer.appendChild(optionDiv);
                                optionDiv.querySelector('.remove-option-btn').addEventListener('click', function() {
                                    if (editOptionsContainer.children.length > 2) {
                                        editOptionsContainer.removeChild(optionDiv);
                                    }
                                });
                            });
                            document.querySelector('.update-poll-btn').dataset.id = pollId;
                        }
                    });
                });
            }

            function showPasswordModal() {
                passwordModal.style.display = 'flex';
                passwordInput.focus();
            }

            function hidePasswordModal() {
                passwordModal.style.display = 'none';
            }

            function showErrorModal() {
                errorModal.style.display = 'flex';
            }

            function hideErrorModal() {
                errorModal.style.display = 'none';
            }

            function showChangePasswordModal() {
                changePasswordModal.style.display = 'flex';
                currentPasswordInput.focus();
            }

            function hideChangePasswordModal() {
                changePasswordModal.style.display = 'none';
                currentPasswordInput.value = '';
                newPasswordInput.value = '';
                confirmPasswordInput.value = '';
            }

            function setupEventListeners() {
                voteBtn.addEventListener('click', submitVote);
                sharePollBtn.addEventListener('click', sharePoll);

                themeToggleBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        themeToggleBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        toggleTheme(this.dataset.theme);
                    });
                });

                createPollBtn.addEventListener('click', () => {
                    showPasswordModal();
                });

                passwordSubmit.addEventListener('click', () => {
                    const password = passwordInput.value;
                    if (password === adminPassword) {
                        isAdmin = true;
                        adminSection.style.display = 'block';
                        activePollEl.style.display = 'none';
                        createPollForm.style.display = 'block';
                        editPollForm.style.display = 'none';
                        hidePasswordModal();
                        updateAdminPanel();
                    } else {
                        passwordInput.value = '';
                        hidePasswordModal();
                        showErrorModal();
                    }
                });

                passwordBackBtn.addEventListener('click', () => {
                    hidePasswordModal();
                    activePollEl.style.display = 'block';
                });

                errorCloseBtn.addEventListener('click', () => {
                    hideErrorModal();
                    activePollEl.style.display = 'block';
                });

                backBtn.addEventListener('click', () => {
                    isAdmin = false;
                    adminSection.style.display = 'none';
                    createPollForm.style.display = "none";
                    editPollForm.style.display = 'none';
                    activePollEl.style.display = 'block';
                    renderPoll();
                });

                nameSubmitBtn.addEventListener('click', () => {
                    voterName = voterNameInput.value.trim();
                    if (!voterName) {
                        errorMessage.textContent = 'Tafadhali jaza jina lako!';
                        errorMessage.style.display = 'block';
                        return;
                    }
                    nameFormModal.style.display = 'none';
                    voterNameInput.value = '';
                    submitVote();
                });

                nameCancelBtn.addEventListener('click', () => {
                    nameFormModal.style.display = 'none';
                    voterNameInput.value = '';
                    voterName = null;
                });

                changePasswordBtn.addEventListener('click', () => {
                    showChangePasswordModal();
                });

                changePasswordSubmit.addEventListener('click', () => {
                    const currentPassword = currentPasswordInput.value;
                    const newPassword = newPasswordInput.value;
                    const confirmPassword = confirmPasswordInput.value;

                    if (currentPassword !== adminPassword) {
                        alert('Nenosiri la sasa sio sahihi!');
                        return;
                    }
                    if (newPassword !== confirmPassword) {
                        alert('Nenosiri jipya na uthibitisho wake havifanani!');
                        return;
                    }
                    if (!newPassword) {
                        alert('Tafadhali jaza nenosiri jipya!');
                        return;
                    }

                    saveAdminPassword(newPassword);
                    alert('Nenosiri limebadilishwa kwa mafanikio!');
                    hideChangePasswordModal();
                });

                changePasswordCancel.addEventListener('click', () => {
                    hideChangePasswordModal();
                });

                document.querySelectorAll('.add-option-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const optionsContainer = e.target.closest('.create-poll-form') ? 
                            document.getElementById('options-container') : 
                            document.getElementById('edit-options-container');
                        const optionCount = optionsContainer.children.length + 1;
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'option-input-container';
                        optionDiv.innerHTML = `
                            <input type="text" class="option-input" placeholder="Chaguo ${optionCount}">
                            <button class="remove-option-btn">‚úï</button>
                        `;
                        optionsContainer.appendChild(optionDiv);
                        optionDiv.querySelector('.remove-option-btn').addEventListener('click', function() {
                            if (optionsContainer.children.length > 2) {
                                optionsContainer.removeChild(optionDiv);
                            }
                        });
                    });
                });

                document.querySelectorAll('.remove-option-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const optionsContainer = document.getElementById('options-container');
                        if (optionsContainer.children.length > 2) {
                            optionsContainer.removeChild(this.parentElement);
                        }
                    });
                });

                const submitPollBtn = document.querySelector('.submit-poll-btn');
                submitPollBtn.addEventListener('click', () => {
                    const titleInput = document.getElementById('poll-title');
                    const optionInputs = document.querySelectorAll('#options-container .option-input');
                    const durationInput = document.getElementById('poll-duration');
                    const durationUnit = document.getElementById('duration-unit');
                    const resultsVisibility = document.getElementById('results-visibility');
                    const requireName = document.getElementById('require-name');
                    const voteLimit = document.getElementById('vote-limit');
                    const voteRestriction = document.getElementById('vote-restriction');
                    const blockVpn = document.getElementById('block-vpn');

                    if (!titleInput.value.trim()) {
                        alert('Tafadhali jaza swali la kura!');
                        return;
                    }

                    let validOptions = [];
                    optionInputs.forEach(input => {
                        if (input.value.trim()) validOptions.push(input.value.trim());
                    });

                    if (validOptions.length < 2) {
                        alert('Tafadhali jaza angalau chaguo 2!');
                        return;
                    }

                    const duration = parseInt(durationInput.value) || 5;
                    const durationUnitValue = durationUnit.value;
                    const durationMultipliers = {
                        seconds: 1000,
                        minutes: 60000,
                        hours: 3600000,
                        weeks: 604800000,
                        months: 2592000000,
                        years: 31536000000
                    };
                    const endTime = new Date().getTime() + duration * durationMultipliers[durationUnitValue];

                    const newPoll = {
                        id: 'poll-' + Date.now(),
                        title: titleInput.value.trim(),
                        author: 'maloshadavid@92gmail.com',
                        date: new Date().toLocaleDateString('sw'),
                        options: validOptions.map((text, index) => ({
                            id: index + 1,
                            text: text,
                            votes: 0
                        })),
                        totalVotes: 0,
                        duration: duration,
                        durationUnit: durationUnitValue,
                        endTime: endTime,
                        isExpired: false,
                        resultsVisibility: resultsVisibility.value,
                        voters: {},
                        settings: {
                            requireName: requireName.value,
                            voteLimit: parseInt(voteLimit.value) || 1,
                            voteRestriction: voteRestriction.value,
                            blockVpn: blockVpn.value
                        }
                    };

                    allPolls = [newPoll];
                    currentPoll = newPoll;
                    savePollsToFirebase();
                    renderPoll();
                    updateAdminPanel();
                    if (shouldShowResults()) showResults();

                    titleInput.value = '';
                    durationInput.value = '';
                    document.getElementById('options-container').innerHTML = `
                        <div class="option-input-container">
                            <input type="text" class="option-input" placeholder="Chaguo 1">
                            <button class="remove-option-btn">‚úï</button>
                        </div>
                        <div class="option-input-container">
                            <input type="text" class="option-input" placeholder="Chaguo 2">
                            <button class="remove-option-btn">‚úï</button>
                        </div>
                    `;
                    activePollEl.style.display = 'block';
                    createPollForm.style.display = 'none';
                });

                const updatePollBtn = document.querySelector('.update-poll-btn');
                updatePollBtn.addEventListener('click', () => {
                    const pollId = updatePollBtn.dataset.id;
                    const titleInput = document.getElementById('edit-poll-title');
                    const durationInput = document.getElementById('edit-poll-duration');
                    const durationUnit = document.getElementById('edit-duration-unit');
                    const resultsVisibility = document.getElementById('edit-results-visibility');
                    const requireName = document.getElementById('edit-require-name');
                    const voteLimit = document.getElementById('edit-vote-limit');
                    const voteRestriction = document.getElementById('edit-vote-restriction');
                    const blockVpn = document.getElementById('edit-block-vpn');
                    const optionInputs = document.querySelectorAll('#edit-options-container .option-input');

                    if (!titleInput.value.trim()) {
                        alert('Tafadhali jaza swali la kura!');
                        return;
                    }

                    let validOptions = [];
                    optionInputs.forEach(input => {
                        if (input.value.trim()) validOptions.push(input.value.trim());
                    });

                    if (validOptions.length < 2) {
                        alert('Tafadhali jaza angalau chaguo 2!');
                        return;
                    }

                    const duration = parseInt(durationInput.value) || 5;
                    const durationUnitValue = durationUnit.value;
                    const durationMultipliers = {
                        seconds: 1000,
                        minutes: 60000,
                        hours: 3600000,
                        weeks: 604800000,
                        months: 2592000000,
                        years: 31536000000
                    };
                    const endTime = new Date().getTime() + duration * durationMultipliers[durationUnitValue];

                    const pollIndex = allPolls.findIndex(p => p.id === pollId);
                    if (pollIndex !== -1) {
                        const existingVoters = allPolls[pollIndex].voters; // Preserve voters
                        allPolls[pollIndex] = {
                            ...allPolls[pollIndex],
                            title: titleInput.value.trim(),
                            duration: duration,
                            durationUnit: durationUnitValue,
                            endTime: endTime,
                            options: validOptions.map((text, index) => ({
                                id: index + 1,
                                text: text,
                                votes: allPolls[pollIndex].options[index] ? allPolls[pollIndex].options[index].votes : 0
                            })),
                            resultsVisibility: resultsVisibility.value,
                            voters: existingVoters, // Keep existing voter data
                            settings: {
                                requireName: requireName.value,
                                voteLimit: parseInt(voteLimit.value) || 1,
                                voteRestriction: voteRestriction.value,
                                blockVpn: blockVpn.value
                            }
                        };
                        currentPoll = allPolls[pollIndex];
                        savePollsToFirebase();
                        renderPoll();
                        updateAdminPanel();
                        if (shouldShowResults()) showResults();
                        editPollForm.style.display = 'none';
                        activePollEl.style.display = 'block';
                    }
                });

                lightModeBtn.addEventListener('click', () => {
                    document.body.classList.remove('dark-mode');
                });

                darkModeBtn.addEventListener('click', () => {
                    document.body.classList.add('dark-mode');
                });
            }

            init();
        });
    </script>
</body>
</html>

